(function(){var t,e,r,n,i,s,a,u,o;e=function(t,r){var n,i,s,a,u;if("object"===$.type(t)&&"object"===$.type(r)){for(i in t)if(s=t[i],!e(s,r[i]))return!1}else if("array"===$.type(t)&&"array"===$.type(r)){for(n=a=0,u=t.length;u>a;n=++a)if(s=t[n],!e(t[n],r[n]))return!1}else if(t!==r)return!1;return!0},s=function(t){var e;return e=/[^\.\[\]]+/g,t.match(e)},r=function(t){var e,r,n,i,a;for(n=s(t),e=i=0,a=n.length;a>i;e=++i)r=n[e],/[0-9]\d*/.test(r)&&(n[e]="$");return n.join(".")},i=function(t){return"input"!==t[0].nodeName.toLowerCase()||"checkbox"!==t.attr("type")&&"radio"!==t.attr("type")?t.val():t.prop("checked")},u=function(t,e,n){var a,u,o,h,c,l,f,p;if(o=s(n),h=t.data,o.length){for(p=[],a=c=0,l=o.length;l>c;a=++c)u=o[a],a<o.length-1?p.push(h=h[u]):(f=h[u],h[u]=i(e),p.push(t.actions[r(n)]?t.actions[r(n)].call(t,{$obj:e,old:f,value:h[u],path:o}):void 0));return p}},n=function(t,e){var r,n,i,a,u,o;if(i=s(t.attr("wine-bind")),i.length){for(a=e,r=u=0,o=i.length;o>u;r=++u)n=i[r],a=a[n];return a}},a=function(t,e,r,n,i){var s,u,o,h,c,l,f,p,d,v;if(h=r,t.indexOf("$")>=0){for(f=t.replace(/\$/g,"\\d+").replace(/\./g,"\\."),v=new RegExp(f),u=c=0,p=i.length;p>c;u=++c)if(s=i[u],v.test(u)&&!a(u,e,r,n,s))return!1;return!0}for(o=t.split("."),l=0,d=o.length;d>l;l++)s=o[l],h=h[s];return e.rule.test(h)?(e.success.call(n,h,i[t]),!0):(e.fail.call(n,h,i[t]),!1)},o=function(t,e){return t.find("[wine-bind]").each(function(){var t,r;return t=$(this),r=n(t,e),"select"===t[0].nodeName.toLowerCase()?t.val(r):"input"!==t[0].nodeName.toLowerCase()||"checkbox"!==t.attr("type")&&"radio"!==t.attr("type")?t.val(r):t.prop("checked",r)})},t=function(){function t(t,e){var r;this.parent=t,this.initialize=e,this.data=null,this.filter=null,this.template=null,this.memorize=null,this.actions={},this.events={},this.watches={},this.validateRules={},this.bindElements={},r=this,this.parent.on("change","[wine-bind]",function(){var t;return t=$(this),u(r,t,t.attr("wine-bind"))})}return t.prototype.setTemplate=function(t){return t.text?this.template=new EJS({text:t.text}):t.url&&(this.template=new EJS({url:t.url})),this},t.prototype.setValidate=function(t){var e,r,n,i,a;for(a=this.validateRules,r=n=0,i=t.length;i>n;r=++n)e=t[r],a[s(e.name).join(".")]={rule:e.rule,success:e.success,fail:e.fail};return this},t.prototype.validate=function(t){var e,r,n,i,s,u,o,h,c;if(n=this,c=this.validateRules,s=this.data,u=n.bindElements,!t){for(r in c)if(i=c[r],!a(r,i,s,n,u))return!1;return!0}if("string"===$.type(t))return a(t,c[t],s,n,u)?!0:!1;if("array"===$.type(t)){for(o=0,h=t.length;h>o;o++)if(e=t[o],!a(e,c[e],s,n,u))return!1;return!0}},t.prototype.value=function(t){return this.beforeValue(),this.data=t,$.extend(!0,t,this.memorize),this.afterValue(),this},t.prototype.beforeValue=function(t){var e;try{t.call(this)}catch(r){e=r}return this},t.prototype.afterValue=function(t){var e;try{t.call(this)}catch(r){e=r}return this},t.prototype.render=function(){var t,e,r,n;r=this;try{this.beforeRenderFn()}catch(i){e=i}t=$("<div></div>"),t.html(this.template.render(this.data)),o(t,r.data),this.parent.empty().append(t.children()),n=r.bindElements={},this.parent.find("[wine-bind]").each(function(){var t,e;return t=$(this),e=s(t.attr("wine-bind")).join("."),n[e]=t});try{this.afterRenderFn()}catch(i){e=i}return this},t.prototype.beforeRender=function(t){return this.beforeRenderFn=t,this},t.prototype.afterRender=function(t){return this.afterRenderFn=t,this},t.prototype.binding=function(t){var e,r,n,i;r=this;for(e in t)n=t[e],i=s(e),r.actions[i.join(".")]=n;return this},t.prototype.unbinding=function(t){var e,r,n;if(r=this,n=function(t){var e;return e=s(t),r.actions[e.join(".")]=null},$.type("string"===t))n(t);else for(e in t)n(e);return this},t.prototype.init=function(){var t;try{this.initialize()}catch(e){t=e}return this},t.prototype.watch=function(t){var e,r,n,i;r=this,i=[];for(e in t)n=t[e],r.events[e]=n,i.push($.Wine.subscribe(r,e));return i},t.prototype.detach=function(t){var e,r,n;r=this,n=[];for(e in t)delete r.events[e],n.push($.Wine.detach(r,e));return n},t}(),jQuery.fn.wine=function(e){var r;return r=$(this),new t(r,e)},jQuery.Wine={subscribers:{},extend:function(t,e){var r,n,i,s,a;s=this.subscribers,a=$.extend({},t),a.parent=$(e),i=t.watches;for(r in i)n=i[r],(n=!0&&s[r]&&s[r].length)&&(a.watches[r]=!0,s[r].push(a));return a},subscribe:function(t,e){return t.watches[e]||(this.subscribers[e]=this.subscribers[e]||[],this.subscribers[e].push(t)),t.watches[e]=!0},trigger:function(t,e){var r,n,i,s,a,u,o,h,c;for(c=this.subscribers[t]||[],s=0,u=c.length;u>s;s++){n=c[s];try{n.events[t].call(n,e)}catch(l){r=l}}for(i=this.subscribers["*"]||[],h=[],a=0,o=i.length;o>a;a++){n=i[a];try{h.push(n.events[t].call(n,e))}catch(l){r=l}}return h},detach:function(t,e){var r,n,i,s,a,u;if(t.watches[e]){for(t.watches[e]=null,u=this.subscribers[e]||[],a=[],n=i=0,s=u.length;s>i;n=++i){if(r=u[n],t===r){u.splice(n,1);break}a.push(void 0)}return a}}}}).call(this);