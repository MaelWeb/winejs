(function(){var t,e,r,n,i,a,s,o,u,h;r=function(t,e){var n,i,a,s,o;if("object"===$.type(t)&&"object"===$.type(e)){for(i in t)if(a=t[i],!r(a,e[i]))return!1}else if("array"===$.type(t)&&"array"===$.type(e)){for(n=s=0,o=t.length;o>s;n=++s)if(a=t[n],!r(t[n],e[n]))return!1}else if(t!==e)return!1;return!0},s=function(t){var e;return e=/[^\.\[\]]+/g,t.match(e)},n=function(t){var e,r,n,i,a;for(n=s(t),e=i=0,a=n.length;a>i;e=++i)r=n[e],/[0-9]\d*/.test(r)&&(n[e]="$");return n.join(".")},a=function(t,e){var r;return"checkbox"===t.attr("type")?t.prop("checked"):"radio"===t.attr("type")?(r=t.attr("name"),e.find(":radio:checked[name="+r+"]").val()):t.val()},u=function(t,e,r){var i,o,u,h,c,l,f,p;if(u=s(r),h=t.data,u.length){for(p=[],i=c=0,l=u.length;l>c;i=++c)o=u[i],i<u.length-1?p.push(h=h[o]):(f=h[o],h[o]=a(e,t.parent),p.push(t.actions[n(r)]?t.actions[n(r)].call(t,{$obj:e,old:f,value:h[o],path:u}):void 0));return p}},i=function(t,e){var r,n,i,a,o,u;if(i=s(t.attr("wine-bind")),i.length){for(a=e,r=o=0,u=i.length;u>o;r=++o)n=i[r],a=a[n];return a}},o=function(t,e,r,n,i){var a,s,u,h,c,l,f,p,d,v;if(h=r,t.indexOf("$")>=0){for(f=t.replace(/\$/g,"\\d+").replace(/\./g,"\\."),v=new RegExp(f),s=c=0,p=i.length;p>c;s=++c)if(a=i[s],v.test(s)&&!o(s,e,r,n,a))return!1;return!0}for(u=t.split("."),l=0,d=u.length;d>l;l++)a=u[l],h=h[a];return e.rule.test(h)?(e.success.call(n,h,i[t]),!0):(e.fail.call(n,h,i[t]),!1)},h=function(t,e){return t.find("[wine-bind]").each(function(){var r,n,a;return r=$(this),a=i(r,e),"select"===r[0].nodeName.toLowerCase()?r.val(a):"input"===r[0].nodeName.toLowerCase()&&"checkbox"===r.attr("type")?r.prop("checked",a):"input"===r[0].nodeName.toLowerCase()&&"radio"===r.attr("type")?(n=r.attr("name"),t.find(":radio[name="+n+"][value="+a+"]").prop("checked",a)):r.val(a)})},e=function(){var t;return t=this,this.parent.off("change").on("change","[wine-bind]",function(){var e;return e=$(this),"radio"!==e.attr("type")||e.prop("checked")?u(t,e,e.attr("wine-bind")):void 0})},t=function(){function t(t,r){this.parent=t,this.initialize=r,this.data=null,this.filter=null,this.template=null,this.memorize=null,this.actions={},this.events={},this.watches={},this.validateRules={},this.bindElements={},this.initialized=!1,e.call(this)}return t.prototype.setTemplate=function(t){return t.text?this.template=new EJS({text:t.text}):t.url&&(this.template=new EJS({url:t.url})),this},t.prototype.setValidate=function(t){var e,r,n,i,a;for(a=this.validateRules,r=n=0,i=t.length;i>n;r=++n)e=t[r],a[s(e.name).join(".")]={rule:e.rule,success:e.success,fail:e.fail};return this},t.prototype.validate=function(t){var e,r,n,i,a,s,u,h,c;if(n=this,c=this.validateRules,a=this.data,s=n.bindElements,!t){for(r in c)if(i=c[r],!o(r,i,a,n,s))return!1;return!0}if("string"===$.type(t))return o(t,c[t],a,n,s)?!0:!1;if("array"===$.type(t)){for(u=0,h=t.length;h>u;u++)if(e=t[u],!o(e,c[e],a,n,s))return!1;return!0}},t.prototype.value=function(t){return this.beforeValue(),this.data=t,$.extend(!0,t,this.memorize),this.afterValue(),this},t.prototype.beforeValue=function(t){var e;try{t.call(this)}catch(r){e=r}return this},t.prototype.afterValue=function(t){var e;try{t.call(this)}catch(r){e=r}return this},t.prototype.render=function(){var t,e,r,n;r=this,this.initialized||(this.init(),this.initialized=!0);try{this.beforeRenderFn()}catch(i){e=i}t=$("<div></div>"),t.html(this.template.render(this.data)),h(t,r.data),this.parent.empty().append(t.children()),n=r.bindElements={},this.parent.find("[wine-bind]").each(function(){var t,e;return t=$(this),e=s(t.attr("wine-bind")).join("."),n[e]=t});try{this.afterRenderFn()}catch(i){e=i}return this},t.prototype.beforeRender=function(t){return this.beforeRenderFn=t,this},t.prototype.afterRender=function(t){return this.afterRenderFn=t,this},t.prototype.binding=function(t){var e,r,n,i;r=this;for(e in t)n=t[e],i=s(e),r.actions[i.join(".")]=n;return this},t.prototype.unbinding=function(t){var e,r,n;if(r=this,n=function(t){var e;return e=s(t),r.actions[e.join(".")]=null},$.type("string"===t))n(t);else for(e in t)n(e);return this},t.prototype.init=function(){var t;try{this.initialize()}catch(e){t=e}return this},t.prototype.watch=function(t){var e,r,n,i;r=this,i=[];for(e in t)n=t[e],r.events[e]=n,i.push($.Wine.subscribe(r,e));return i},t.prototype.detach=function(t){var e,r,n;r=this,n=[];for(e in t)delete r.events[e],n.push($.Wine.detach(r,e));return n},t}(),jQuery.fn.wine=function(e){var r;return r=$(this),new t(r,e)},jQuery.Wine={subscribers:{},extend:function(t,r){var n,i,a,s,o;s=this.subscribers,o=$.extend(!0,{},t),o.parent=$(r),a=t.watches;for(n in a)i=a[n],(i=!0&&s[n]&&s[n].length)&&(o.watches[n]=!0,s[n].push(o));return e.call(o),o},subscribe:function(t,e){return t.watches[e]||(this.subscribers[e]=this.subscribers[e]||[],this.subscribers[e].push(t)),t.watches[e]=!0},trigger:function(t,e){var r,n,i,a,s,o,u,h,c;for(c=this.subscribers[t]||[],a=0,o=c.length;o>a;a++){n=c[a];try{n.events[t].call(n,e)}catch(l){r=l}}for(i=this.subscribers["*"]||[],h=[],s=0,u=i.length;u>s;s++){n=i[s];try{h.push(n.events[t].call(n,e))}catch(l){r=l}}return h},detach:function(t,e){var r,n,i,a,s,o;if(t.watches[e]){for(t.watches[e]=null,o=this.subscribers[e]||[],s=[],n=i=0,a=o.length;a>i;n=++i){if(r=o[n],t===r){o.splice(n,1);break}s.push(void 0)}return s}}}}).call(this);