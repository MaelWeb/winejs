(function(){var t,e,r,n,i,a,s,o,u;e=function(t,r){var n,i,a,s,o;if("object"===$.type(t)&&"object"===$.type(r)){for(i in t)if(a=t[i],!e(a,r[i]))return!1}else if("array"===$.type(t)&&"array"===$.type(r)){for(n=s=0,o=t.length;o>s;n=++s)if(a=t[n],!e(t[n],r[n]))return!1}else if(t!==r)return!1;return!0},a=function(t){var e;return e=/[^\.\[\]]+/g,t.match(e)},r=function(t){var e,r,n,i,s;for(n=a(t),e=i=0,s=n.length;s>i;e=++i)r=n[e],/[0-9]\d*/.test(r)&&(n[e]="$");return n.join(".")},i=function(t,e){var r;return"checkbox"===t.attr("type")?t.prop("checked"):"radio"===t.attr("type")?(r=t.attr("name"),e.find(":radio:checked[name="+r+"]").val()):t.val()},o=function(t,e,n){var s,o,u,h,c,l,f,p;if(u=a(n),h=t.data,u.length){for(p=[],s=c=0,l=u.length;l>c;s=++c)o=u[s],s<u.length-1?p.push(h=h[o]):(f=h[o],h[o]=i(e,t.parent),p.push(t.actions[r(n)]?t.actions[r(n)].call(t,{$obj:e,old:f,value:h[o],path:u}):void 0));return p}},n=function(t,e){var r,n,i,s,o,u;if(i=a(t.attr("wine-bind")),i.length){for(s=e,r=o=0,u=i.length;u>o;r=++o)n=i[r],s=s[n];return s}},s=function(t,e,r,n,i){var a,o,u,h,c,l,f,p,d,v;if(h=r,t.indexOf("$")>=0){for(f=t.replace(/\$/g,"\\d+").replace(/\./g,"\\."),v=new RegExp(f),o=c=0,p=i.length;p>c;o=++c)if(a=i[o],v.test(o)&&!s(o,e,r,n,a))return!1;return!0}for(u=t.split("."),l=0,d=u.length;d>l;l++)a=u[l],h=h[a];return e.rule.test(h)?(e.success.call(n,h,i[t]),!0):(e.fail.call(n,h,i[t]),!1)},u=function(t,e){return t.find("[wine-bind]").each(function(){var r,i,a;return r=$(this),a=n(r,e),"select"===r[0].nodeName.toLowerCase()?r.val(a):"input"===r[0].nodeName.toLowerCase()&&"checkbox"===r.attr("type")?r.prop("checked",a):"input"===r[0].nodeName.toLowerCase()&&"radio"===r.attr("type")?(i=r.attr("name"),t.find(":radio[name="+i+"][value="+a+"]").prop("checked",a)):r.val(a)})},t=function(){function t(t,e){var r;this.parent=t,this.initialize=e,this.data=null,this.filter=null,this.template=null,this.memorize=null,this.actions={},this.events={},this.watches={},this.validateRules={},this.bindElements={},this.initialized=!1,r=this,this.parent.on("change","[wine-bind]",function(){var t;return t=$(this),"radio"!==t.attr("type")||t.prop("checked")?o(r,t,t.attr("wine-bind")):void 0})}return t.prototype.setTemplate=function(t){return t.text?this.template=new EJS({text:t.text}):t.url&&(this.template=new EJS({url:t.url})),this},t.prototype.setValidate=function(t){var e,r,n,i,s;for(s=this.validateRules,r=n=0,i=t.length;i>n;r=++n)e=t[r],s[a(e.name).join(".")]={rule:e.rule,success:e.success,fail:e.fail};return this},t.prototype.validate=function(t){var e,r,n,i,a,o,u,h,c;if(n=this,c=this.validateRules,a=this.data,o=n.bindElements,!t){for(r in c)if(i=c[r],!s(r,i,a,n,o))return!1;return!0}if("string"===$.type(t))return s(t,c[t],a,n,o)?!0:!1;if("array"===$.type(t)){for(u=0,h=t.length;h>u;u++)if(e=t[u],!s(e,c[e],a,n,o))return!1;return!0}},t.prototype.value=function(t){return this.beforeValue(),this.data=t,$.extend(!0,t,this.memorize),this.afterValue(),this},t.prototype.beforeValue=function(t){var e;try{t.call(this)}catch(r){e=r}return this},t.prototype.afterValue=function(t){var e;try{t.call(this)}catch(r){e=r}return this},t.prototype.render=function(){var t,e,r,n;r=this,this.initialized||(this.init(),this.initialized=!0);try{this.beforeRenderFn()}catch(i){e=i}t=$("<div></div>"),t.html(this.template.render(this.data)),u(t,r.data),this.parent.empty().append(t.children()),n=r.bindElements={},this.parent.find("[wine-bind]").each(function(){var t,e;return t=$(this),e=a(t.attr("wine-bind")).join("."),n[e]=t});try{this.afterRenderFn()}catch(i){e=i}return this},t.prototype.beforeRender=function(t){return this.beforeRenderFn=t,this},t.prototype.afterRender=function(t){return this.afterRenderFn=t,this},t.prototype.binding=function(t){var e,r,n,i;r=this;for(e in t)n=t[e],i=a(e),r.actions[i.join(".")]=n;return this},t.prototype.unbinding=function(t){var e,r,n;if(r=this,n=function(t){var e;return e=a(t),r.actions[e.join(".")]=null},$.type("string"===t))n(t);else for(e in t)n(e);return this},t.prototype.init=function(){var t;try{this.initialize()}catch(e){t=e}return this},t.prototype.watch=function(t){var e,r,n,i;r=this,i=[];for(e in t)n=t[e],r.events[e]=n,i.push($.Wine.subscribe(r,e));return i},t.prototype.detach=function(t){var e,r,n;r=this,n=[];for(e in t)delete r.events[e],n.push($.Wine.detach(r,e));return n},t}(),jQuery.fn.wine=function(e){var r;return r=$(this),new t(r,e)},jQuery.Wine={subscribers:{},extend:function(t,e){var r,n,i,a,s;a=this.subscribers,s=$.extend({},t),s.parent=$(e),i=t.watches;for(r in i)n=i[r],(n=!0&&a[r]&&a[r].length)&&(s.watches[r]=!0,a[r].push(s));return s},subscribe:function(t,e){return t.watches[e]||(this.subscribers[e]=this.subscribers[e]||[],this.subscribers[e].push(t)),t.watches[e]=!0},trigger:function(t,e){var r,n,i,a,s,o,u,h,c;for(c=this.subscribers[t]||[],a=0,o=c.length;o>a;a++){n=c[a];try{n.events[t].call(n,e)}catch(l){r=l}}for(i=this.subscribers["*"]||[],h=[],s=0,u=i.length;u>s;s++){n=i[s];try{h.push(n.events[t].call(n,e))}catch(l){r=l}}return h},detach:function(t,e){var r,n,i,a,s,o;if(t.watches[e]){for(t.watches[e]=null,o=this.subscribers[e]||[],s=[],n=i=0,a=o.length;a>i;n=++i){if(r=o[n],t===r){o.splice(n,1);break}s.push(void 0)}return s}}}}).call(this);